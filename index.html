<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêã Whale Tracker - Discover Ocean Giants</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
    /* --- Base Styles --- */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        /* Colors */
        --ocean-deep: #0A1628;
        --ocean-dark: #1E3A5F;
        --ocean-primary: #2E5F88;
        --ocean-light: #4A90E2;
        --ocean-accent: #64B5F6;
        --foam-white: #F5F9FF;
        --pure-white: #FFFFFF;
        --coral: #FF6B6B;
        --seafoam: #4ECDC4;
        --sunset: #FFE66D;
        --whale-purple: #7B68EE;

        /* Shadows */
        --shadow-sm: 0 2px 8px rgba(10, 22, 40, 0.08);
        --shadow-md: 0 4px 20px rgba(10, 22, 40, 0.12);
        --shadow-lg: 0 10px 40px rgba(10, 22, 40, 0.15);
        --shadow-xl: 0 20px 60px rgba(10, 22, 40, 0.2);

        /* Layout Heights (Desktop Defaults) */
        --header-height: 80px; /* Approximate height of your header */
        --controls-height-desktop: 140px; /* Approximate combined height of buttons + stats for desktop */
        --controls-padding-y-desktop: 0.5rem; /* Vertical padding inside .controls for desktop */
    }

    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
    }

    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, var(--ocean-deep) 0%, var(--ocean-dark) 100%);
        color: var(--pure-white);
        line-height: 1.6;
        position: relative;
    }

    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 20% 30%, rgba(78, 205, 196, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 60%, rgba(100, 181, 246, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 80%, rgba(123, 104, 238, 0.1) 0%, transparent 50%);
        pointer-events: none;
        z-index: 1;
    }

    /* Animated Ocean Waves Background */
    .ocean-bg {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 200px;
        background: linear-gradient(180deg, transparent 0%, rgba(46, 95, 136, 0.1) 100%);
        z-index: 0;
        overflow: hidden;
    }

    .wave {
        position: absolute;
        bottom: -5px;
        left: 0;
        width: 200%;
        height: 100px;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%234A90E2' fill-opacity='0.1' d='M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,112C672,96,768,96,864,112C960,128,1056,160,1152,160C1248,160,1344,128,1392,112L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z'%3E%3C/path%3E%3C/svg%3E") repeat-x;
        animation: wave-animation 20s linear infinite;
    }

    .wave:nth-child(2) {
        bottom: 10px;
        opacity: 0.5;
        animation-duration: 15s;
        animation-direction: reverse;
    }

    .wave:nth-child(3) {
        bottom: 20px;
        opacity: 0.3;
        animation-duration: 25s;
    }

    @keyframes wave-animation {
        0% { transform: translateX(0); }
        100% { transform: translateX(-50%); }
    }

    /* Header - Cleaner design with stats moved */
    .header {
        background: rgba(10, 22, 40, 0.85);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(100, 181, 246, 0.2);
        padding: 0.8rem 1rem; /* Adjusted padding */
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        height: var(--header-height); /* Set a fixed height */
        display: flex;
        align-items: center;
        justify-content: center; /* Center content horizontally */
    }

    .header-content {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: center; /* Center content horizontally */
        gap: 1rem; /* Smaller gap */
        position: relative;
        flex: 1; /* Allow to take available space */
    }

    .whale-header {
        display: flex;
        align-items: center;
        gap: 0.8rem; /* Smaller gap */
    }

    .giant-whale {
        font-size: 3rem; /* Slightly smaller for cleaner header */
        filter: drop-shadow(0 8px 20px rgba(100, 181, 246, 0.4));
        animation: bob 4s ease-in-out infinite;
        position: relative;
        z-index: 2;
        cursor: pointer;
        transition: transform 0.3s ease;
    }

    .giant-whale:hover {
        transform: scale(1.1) rotate(10deg);
    }

    @keyframes bob {
        0% { 
            transform: translateY(0) translateX(0) rotate(0deg);
        }
        25% { 
            transform: translateY(-8px) translateX(5px) rotate(-5deg);
        }
        50% { 
            transform: translateY(0) translateX(10px) rotate(0deg);
        }
        75% { 
            transform: translateY(-5px) translateX(5px) rotate(5deg);
        }
        100% { 
            transform: translateY(0) translateX(0) rotate(0deg);
        }
    }

    .header h1 {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 1.6rem; /* Adjusted font size */
        font-weight: 700;
        color: var(--pure-white);
        margin: 0;
        letter-spacing: -0.02em;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    /* Water ripple effect behind whale */
    .giant-whale::before {
        content: '';
        position: absolute;
        bottom: -5px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 10px;
        background: radial-gradient(ellipse, rgba(100, 181, 246, 0.3) 0%, transparent 70%);
        border-radius: 50%;
        animation: ripple 4s ease-in-out infinite;
    }

    @keyframes ripple {
        0%, 100% { 
            transform: translateX(-50%) scaleX(0.5);
            opacity: 0;
        }
        50% { 
            transform: translateX(-50%) scaleX(1.5);
            opacity: 1;
        }
    }

    /* .stats (now moved to bottom) - Hide this if it exists in the header */
    .stats {
        display: none; 
    }

    /* Map Container */
    .map-container {
        position: relative;
        height: 100%; /* Take full height initially */
        width: 100%;
        margin-top: var(--header-height); /* Use CSS variable */
        z-index: 10;
    }

    #map {
        height: calc(100vh - var(--header-height) - var(--controls-height-desktop)); /* Dynamic height calculation */
        width: 100%;
        position: relative;
        z-index: 10;
    }

    /* Custom Map Styling */
    .leaflet-container {
        background: var(--ocean-deep); /* Use CSS variable */
        font-family: 'Inter', sans-serif;
    }

    .leaflet-tile-pane {
        filter: brightness(0.8) contrast(1.2) hue-rotate(180deg) invert(1);
        opacity: 0.7;
    }

    /* --- Controls (Bottom Navigation & Stats) --- */
    .controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 0.8rem 1.2rem; /* Adjusted padding for a more compact bar */
        display: flex;
        flex-direction: column; /* Stack buttons and stats vertically */
        gap: 0.6rem; /* Gap between button section and stats section */
        z-index: 1000;
        border-radius: 35px; /* Slightly adjusted radius */
        box-shadow: var(--shadow-xl);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        width: fit-content; /* Make the width fit its content */
        min-width: 300px; /* Ensure a minimum width for desktop */
    }

    .control-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center; /* Center buttons */
        width: 100%; /* Take full width within controls */
    }

    .control-btn {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        padding: 0.8rem 1.5rem;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0; /* Prevent buttons from shrinking too much */
    }

    .control-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-accent) 100%);
        border-radius: 25px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: -1; /* Place behind text */
    }

    .control-btn:hover {
        color: var(--pure-white);
        transform: translateY(-2px);
    }

    .control-btn:hover::before {
        opacity: 0.2;
    }

    .control-btn.active {
        color: var(--pure-white);
        background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-accent) 100%);
        box-shadow: 0 4px 15px rgba(100, 181, 246, 0.4);
    }

    .control-btn.loading {
        animation: pulse-glow 1.5s ease-in-out infinite;
    }

    @keyframes pulse-glow {
        0%, 100% { 
            box-shadow: 0 0 20px rgba(100, 181, 246, 0.4);
        }
        50% { 
            box-shadow: 0 0 30px rgba(100, 181, 246, 0.6);
        }
    }

    .control-btn .btn-icon {
        font-size: 1.2rem;
    }

    .bottom-stats {
        display: flex;
        flex-wrap: wrap; /* Allow stats to wrap */
        gap: 0.4rem; /* Smaller gap between stat pills */
        justify-content: center; /* Center stat pills */
        width: 100%; /* Take full width within controls */
        padding-top: 0.6rem; /* Separation from buttons */
        border-top: 1px solid rgba(255, 255, 255, 0.15); /* Subtle separator */
    }

    .stat-pill {
        background: rgba(100, 181, 246, 0.1); /* Slightly less opaque */
        border: 1px solid rgba(100, 181, 246, 0.25); /* Slightly less opaque border */
        padding: 0.3rem 0.7rem; /* Compact padding */
        border-radius: 20px; /* Slightly smaller border radius */
        font-size: 0.7rem; /* Smaller font size for stats */
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px; /* Smaller gap */
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: default;
        color: var(--pure-white);
    }

    .stat-pill .stat-icon {
        font-size: 0.8rem; /* Adjusted icon size */
    }

    .stat-pill .stat-value {
        color: var(--ocean-accent);
        font-weight: 600; /* Slightly less bold */
        font-size: 0.8rem; /* Adjusted value size */
        text-shadow: none; /* Remove text shadow for cleaner look */
    }


    /* Species Filter - Modern Card Design */
    .species-filter {
        position: fixed;
        top: calc(var(--header-height) + 20px); /* Adjust based on new header height */
        left: 20px;
        right: 20px;
        bottom: calc(20px + (var(--controls-height-desktop) * 1.0)); /* Adjusted based on controls bottom + controls height */
        max-height: calc(100vh - var(--header-height) - var(--controls-height-desktop) - 60px); /* Dynamic height */
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        padding: 2rem;
        display: none;
        z-index: 999;
        border-radius: 24px;
        box-shadow: var(--shadow-xl);
        overflow-y: auto;
        animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .species-filter.active {
        display: block;
    }

    .filter-header {
        color: var(--ocean-dark);
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        text-align: center;
        font-family: 'Space Grotesk', sans-serif;
    }

    .species-list {
        display: grid;
        gap: 12px;
    }

    .species-tag {
        background: var(--foam-white);
        border: 2px solid transparent;
        color: var(--ocean-dark);
        padding: 1.2rem;
        border-radius: 16px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        overflow: hidden;
    }

    .species-tag::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(100, 181, 246, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .species-tag:hover::before {
        left: 100%;
    }

    .species-tag:hover {
        transform: translateX(5px);
        border-color: var(--ocean-accent);
        box-shadow: var(--shadow-md);
    }

    .species-tag.active {
        background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-accent) 100%);
        color: var(--pure-white);
        border-color: transparent;
        box-shadow: 0 4px 15px rgba(100, 181, 246, 0.3);
    }

    .species-tag .species-emoji {
        font-size: 1.5rem;
        margin-right: 10px;
    }

    /* Whale Markers */
    .whale-marker {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        animation: marker-bounce 2s ease-in-out infinite;
        cursor: pointer;
        transition: transform 0.3s ease;
    }

    .whale-marker:hover {
        transform: scale(1.2);
    }

    @keyframes marker-bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }

    /* Full Screen Modal for Mobile */
    .whale-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10, 22, 40, 0.95);
        backdrop-filter: blur(20px);
        z-index: 2000;
        overflow-y: auto;
        animation: modalFadeIn 0.3s ease-out;
    }

    @keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: translateY(100%);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .whale-modal.active {
        display: flex;
        flex-direction: column;
    }

    .modal-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 10;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: all;
        touch-action: manipulation;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .whale-modal-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
    }

    .whale-modal-image {
        position: relative;
        width: 100%;
        height: 50vh;
        background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-accent) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .whale-modal-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .whale-modal-emoji {
        font-size: 8rem;
        filter: drop-shadow(0 10px 40px rgba(0, 0, 0, 0.3));
        animation: modalFloat 4s ease-in-out infinite;
    }

    @keyframes modalFloat {
        0%, 100% { transform: translateY(0) scale(1); }
        50% { transform: translateY(-20px) scale(1.05); }
    }

    .whale-modal-info {
        flex: 1;
        background: white;
        padding: 2rem;
        border-top-left-radius: 30px;
        border-top-right-radius: 30px;
        margin-top: -30px;
        position: relative;
        color: var(--ocean-dark);
    }

    .whale-modal-badge {
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--ocean-accent);
        color: white;
        padding: 0.5rem 2rem;
        border-radius: 30px;
        font-size: 0.9rem;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(100, 181, 246, 0.4);
    }

    .whale-modal-title {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 2rem;
        font-weight: 700;
        color: var(--ocean-dark);
        margin-bottom: 1rem;
        margin-top: 1.5rem;
        text-align: center;
    }

    .whale-modal-location {
        font-size: 1.2rem;
        font-weight: 500;
        color: var(--ocean-dark);
        text-align: center;
        margin-bottom: 2rem;
    }

    .whale-modal-details {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .whale-modal-detail {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--foam-white);
        border-radius: 12px;
        transition: all 0.3s ease;
    }

    .whale-modal-detail:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-md);
    }

    .whale-modal-detail-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        background: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-sm);
    }

    .whale-modal-detail-content {
        flex: 1;
    }

    .whale-modal-detail-label {
        font-size: 0.85rem;
        color: rgba(10, 22, 40, 0.6);
        font-weight: 500;
    }

    .whale-modal-detail-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--ocean-dark);
    }

    .whale-modal-coordinates {
        font-family: 'Space Grotesk', monospace;
        color: var(--ocean-light);
    }

    /* Whale Popups (Desktop Only) */
    .whale-popup {
        color: var(--ocean-dark);
        position: relative;
        overflow: hidden;
    }

    .whale-popup-header {
        position: relative;
        height: 180px;
        background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-accent) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .whale-popup-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        animation: rotate 20s linear infinite;
    }

    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .whale-popup-header img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: relative;
        z-index: 1;
    }

    .whale-popup-emoji {
        font-size: 5rem;
        filter: drop-shadow(0 4px 20px rgba(0, 0, 0, 0.2));
        z-index: 2;
        animation: float 3s ease-in-out infinite;
    }

    .whale-popup-content {
        padding: 1.5rem;
    }

    .whale-popup h3 {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--ocean-dark);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .whale-popup-badge {
        display: inline-block;
        background: var(--ocean-accent);
        color: var(--pure-white);
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .whale-popup p {
        color: var(--ocean-dark);
        font-size: 0.95rem;
        margin-bottom: 0.8rem;
        line-height: 1.6;
    }

    .whale-popup-meta {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(10, 22, 40, 0.1);
    }

    .whale-popup-meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: rgba(10, 22, 40, 0.6);
    }

    .whale-popup-meta-item .meta-icon {
        font-size: 1rem;
        color: var(--ocean-accent);
    }

    .coordinates-display {
        font-family: 'Space Grotesk', monospace;
        font-size: 0.8rem;
        color: var(--ocean-light);
        background: rgba(10, 22, 40, 0.05);
        padding: 0.2rem 0.5rem;
        border-radius: 6px;
        margin-left: 4px;
    }

    /* Loading Screen - Ocean Theme */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, var(--ocean-deep) 0%, var(--ocean-dark) 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        transition: opacity 0.5s ease;
    }

    .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .loading-content {
        text-align: center;
        position: relative;
        z-index: 2;
    }

    .whale-spinner {
        font-size: 5rem;
        animation: swim 3s ease-in-out infinite;
        filter: drop-shadow(0 10px 30px rgba(100, 181, 246, 0.3));
        margin-bottom: 2rem;
    }

    @keyframes swim {
        0%, 100% { 
            transform: translateX(0) translateY(0) rotate(0deg);
        }
        25% { 
            transform: translateX(20px) translateY(-10px) rotate(10deg);
        }
        50% { 
            transform: translateX(0) translateY(-20px) rotate(0deg);
        }
        75% { 
            transform: translateX(-20px) translateY(-10px) rotate(-10deg);
        }
    }

    .loading-text {
        font-family: 'Space Grotesk', sans-serif;
        font-size: 1.2rem;
        font-weight: 500;
        color: var(--ocean-accent);
        letter-spacing: 0.02em;
        animation: fade-pulse 2s ease-in-out infinite;
    }

    @keyframes fade-pulse {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
    }

    .loading-dots {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-top: 1rem;
    }

    .loading-dot {
        width: 10px;
        height: 10px;
        background: var(--ocean-accent);
        border-radius: 50%;
        animation: dot-wave 1.5s ease-in-out infinite;
    }

    .loading-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .loading-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes dot-wave {
        0%, 100% { 
            transform: translateY(0);
            opacity: 0.3;
        }
        50% { 
            transform: translateY(-10px);
            opacity: 1;
        }
    }

    /* --- Responsive Design --- */

    /* Desktop adjustments for modal */
    @media (min-width: 769px) {
        .whale-modal-content {
            max-width: 600px;
            margin: 2rem auto;
            border-radius: 24px;
            overflow: hidden;
            min-height: auto;
            box-shadow: var(--shadow-xl);
        }

        .whale-modal-image {
            height: 300px;
            border-radius: 24px 24px 0 0;
        }

        .modal-close {
            background: rgba(0, 0, 0, 0.5);
        }

        /* Ensure popups show on desktop */
        .leaflet-popup {
            display: block !important; 
        }
    }

    /* Mobile adjustments (up to 768px) */
    @media (max-width: 768px) {
        :root {
            --header-height: 70px; /* Smaller header on mobile */
            --controls-height-mobile: 130px; /* Adjusted combined controls height on mobile */
        }

        .header {
            padding: 0.6rem 0.8rem; /* Further adjusted padding for smaller header */
            height: var(--header-height);
        }

        .header h1 {
            font-size: 1.4rem; /* Smaller header title */
        }

        .giant-whale {
            font-size: 2.5rem; /* Smaller whale icon in header */
        }

        .map-container {
            margin-top: var(--header-height); /* Update margin based on new header height */
        }

        #map {
            height: calc(100vh - var(--header-height) - var(--controls-height-mobile) - 10px); /* Adjust map height for new controls/header */
        }

        .controls {
            bottom: 10px;
            padding: 0.5rem; /* Slightly more padding for touch targets */
            border-radius: 40px; /* Larger radius for mobile */
            gap: 0.6rem;
            width: 90%; /* Take more width on mobile */
            max-width: 400px; /* Max width for controls on mobile */
        }

        .control-buttons {
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 0.4rem; /* Slightly larger gap between buttons */
        }
        
        .control-btn {
            padding: 0.7rem 1.2rem; /* Adjusted padding for better touch target */
            font-size: 0.85rem;
            flex: 1; /* Allow buttons to grow and fill space */
            min-width: 70px; /* Ensure minimum width for button text */
        }
        
        /* Hide Leaflet popups on mobile */
        .leaflet-popup {
            display: none !important;
        }

        .whale-popup-content {
            width: 280px !important; /* Fixed width for mobile popups (if they were enabled) */
        }

        .whale-popup h3 {
            font-size: 1.2rem;
        }

        .loading-text {
            font-size: 1rem;
        }

        .whale-spinner {
            font-size: 4rem;
        }

        .species-filter {
            top: calc(var(--header-height) + 10px); /* Adjusted top for filter */
            bottom: calc(10px + var(--controls-height-mobile)); /* Adjusted bottom for filter */
            max-height: calc(100vh - var(--header-height) - var(--controls-height-mobile) - 20px);
            padding: 1.5rem;
            left: 10px;
            right: 10px;
        }

        .species-tag {
            padding: 1rem;
            font-size: 0.9rem;
        }
    }

    /* Very small mobile adjustments (up to 375px or 420px) */
    @media (max-width: 420px) {
        :root {
            --header-height: 60px; /* Even smaller header */
            --controls-height-mobile: 110px; /* Slightly smaller controls */
        }

        .header {
            padding: 0.5rem 0.5rem;
            height: var(--header-height);
        }
        
        .giant-whale {
            font-size: 2.2rem; /* Smallest whale icon */
        }

        .header h1 {
            font-size: 1.1rem; /* Smallest header title */
        }

        .map-container {
            margin-top: var(--header-height);
        }

        #map {
            height: calc(100vh - var(--header-height) - var(--controls-height-mobile) - 5px); /* Reduce extra padding */
        }

        .controls {
            padding: 0.4rem;
            gap: 0.5rem;
            bottom: 5px; /* Closer to bottom edge */
            border-radius: 30px; /* Slightly smaller border-radius */
        }

        .control-buttons {
            gap: 0.3rem;
        }

        .control-btn {
            padding: 0.5rem 0.8rem;
            font-size: 0.75rem;
            gap: 4px; /* Smaller gap in button */
            min-width: unset; /* Remove min-width to allow more flexibility */
        }

        .control-btn .btn-icon {
            display: none; /* Hide icons on very small screens to save space */
        }

        .bottom-stats {
            padding-top: 0.3rem;
            gap: 0.3rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1); /* Keep separator */
        }
        .stat-pill {
            padding: 0.25rem 0.6rem; /* Slightly more compact */
            font-size: 0.65rem;
            gap: 3px; /* Even smaller gap */
        }
        .stat-pill .stat-icon {
            font-size: 0.75rem;
        }
        .stat-pill .stat-value {
            font-size: 0.75rem;
        }

        .species-filter {
            top: calc(var(--header-height) + 10px);
            bottom: calc(5px + var(--controls-height-mobile)); /* Adjust bottom based on new controls bottom */
            max-height: calc(100vh - var(--header-height) - var(--controls-height-mobile) - 15px);
        }
    }
	/* Header - Floating Whale Design */
.header {
    background: transparent;  /* Remove the dark background */
    backdrop-filter: none;    /* Remove the blur effect */
    border-bottom: none;      /* Remove the border */
    padding: 1rem;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: none;         /* Remove the shadow */
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Remove the whale's drop shadow */
.giant-whale {
    font-size: 3.5rem;
    filter: none;  /* Remove the drop-shadow */
    animation: bob 4s ease-in-out infinite;
    position: relative;
    z-index: 2;
    cursor: pointer;
    transition: transform 0.3s ease;
}

/* Make the title more visible against map background */
.header h1 {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--pure-white);
    margin: 0;
    letter-spacing: -0.02em;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);  /* Add shadow to text for readability */
}

/* Make stats pills more visible against map */
.stat-pill {
    background: rgba(10, 22, 40, 0.8);  /* Darker background for contrast */
    border: 1px solid rgba(100, 181, 246, 0.3);
    /* ... rest of existing styles ... */
}
</style>
</head>
<body>
    <div class="ocean-bg">
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="wave"></div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="whale-spinner">üêã</div>
            <div class="loading-text">Discovering ocean giants...</div>
            <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
    </div>

    <div class="whale-modal" id="whaleModal">
        <button class="modal-close" id="modalClose">√ó</button>
        <div class="whale-modal-content">
            <div class="whale-modal-image" id="modalImage">
                <div class="whale-modal-emoji" id="modalEmoji">üêã</div>
            </div>
            <div class="whale-modal-info">
                <div class="whale-modal-badge">Recent Sighting</div>
                <h2 class="whale-modal-title" id="modalTitle">Whale Name</h2>
                <p class="whale-modal-location" id="modalLocation">Location</p>
                
                <div class="whale-modal-details">
                    <div class="whale-modal-detail">
                        <div class="whale-modal-detail-icon">üìÖ</div>
                        <div class="whale-modal-detail-content">
                            <div class="whale-modal-detail-label">Date Spotted</div>
                            <div class="whale-modal-detail-value" id="modalDate">--</div>
                        </div>
                    </div>
                    
                    <div class="whale-modal-detail">
                        <div class="whale-modal-detail-icon">üìç</div>
                        <div class="whale-modal-detail-content">
                            <div class="whale-modal-detail-label">Coordinates</div>
                            <div class="whale-modal-detail-value whale-modal-coordinates" id="modalCoords">--</div>
                        </div>
                    </div>
                    
                    <div class="whale-modal-detail" id="modalRecorderSection">
                        <div class="whale-modal-detail-icon">üë§</div>
                        <div class="whale-modal-detail-content">
                            <div class="whale-modal-detail-label">Recorded By</div>
                            <div class="whale-modal-detail-value" id="modalRecorder">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="whale-header">
                <div class="giant-whale">üêã</div>
                <h1>Whello!</h1>
            </div>
            </div>
    </header>

    <div class="species-filter" id="speciesFilter">
        <h2 class="filter-header">Select Species to Track</h2>
        <div class="species-list" id="speciesList"></div>
    </div>

    <div class="map-container">
        <div id="map"></div>
    </div>

    <div class="controls">
        <div class="control-buttons">
            <button class="control-btn active" id="mapViewBtn">
                <span class="btn-icon">üó∫Ô∏è</span>
                <span>Map</span>
            </button>
            <button class="control-btn" id="filterBtn">
                <span class="btn-icon">üîç</span>
                <span>Filter</span>
            </button>
            <button class="control-btn" id="refreshBtn">
                <span class="btn-icon">üîÑ</span>
                <span>Refresh</span>
            </button>
        </div>
        <div class="bottom-stats">
            <div class="stat-pill">
                <span class="stat-icon">üìç</span>
                <span>Sightings: <span class="stat-value" id="sightingCount">0</span></span>
            </div>
            <div class="stat-pill">
                <span class="stat-icon">üêã</span>
                <span>Species: <span class="stat-value" id="speciesCount">0</span></span>
            </div>
            <div class="stat-pill">
                <span class="stat-icon">üïê</span>
                <span>Updated: <span class="stat-value" id="lastUpdate">--:--</span></span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        class WhaleTracker {
            constructor() {
                this.map = null;
                this.whaleData = [];
                this.markers = [];
                this.activeSpecies = new Set();
                
                this.initialMapCenter = [20, -140]; // Store initial center
                this.initialMapZoom = 3;             // Store initial zoom
                
                this.init();
            }

            async init() {
                this.initMap();
                this.setupEventListeners();
                await this.loadWhaleData();
                this.hideLoading();
                this.updateStats(); 
            }

            initMap() {
                this.map = L.map('map', {
                    zoomControl: false,
                    attributionControl: false,
                    maxBoundsViscosity: 1.0
                }).setView(this.initialMapCenter, this.initialMapZoom); // Use stored initial values

                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 18
                }).addTo(this.map);

                L.control.zoom({
                    position: 'topright'
                }).addTo(this.map);
                
                // Custom popup positioning for mobile
                this.map.on('popupopen', (e) => {
                    const popup = e.popup;
                    const popupHeight = popup._container.offsetHeight;
                    const mapHeight = this.map.getSize().y;
                    const headerHeight = window.innerWidth <= 768 ? 170 : 140;
                    
                    // Check if popup would be cut off at the top
                    const popupTop = this.map.latLngToContainerPoint(popup._latlng).y - popupHeight;
                    
                    if (popupTop < headerHeight) {
                        // Calculate new position to ensure popup is fully visible
                        const targetY = headerHeight + popupHeight / 2 + 20;
                        const targetPoint = L.point(
                            this.map.latLngToContainerPoint(popup._latlng).x,
                            targetY
                        );
                        const targetLatLng = this.map.containerPointToLatLng(targetPoint);
                        
                        // Smoothly pan to show the popup
                        this.map.panTo(targetLatLng, {
                            animate: true,
                            duration: 0.5
                        });
                    }
                });
            }

            setupEventListeners() {
                // Modal close button
                const modalCloseBtn = document.getElementById('modalClose');
                if (modalCloseBtn) {
                    modalCloseBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.closeWhaleModal();
                    };
                }
                
                // Modal background click to close
                const whaleModal = document.getElementById('whaleModal');
                if (whaleModal) {
                    whaleModal.onclick = (e) => {
                        if (e.target === whaleModal) {
                            this.closeWhaleModal();
                        }
                    };
                }
                
                // Escape key to close modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.getElementById('whaleModal').classList.contains('active')) {
                        this.closeWhaleModal();
                    }
                });
                
                // Map view button
                document.getElementById('mapViewBtn').addEventListener('click', () => {
                    console.log('Map View Button Clicked!');
                    document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('mapViewBtn').classList.add('active');
                    document.getElementById('speciesFilter').classList.remove('active');
                    
                    // Reset map view to initial state
                    this.map.setView(this.initialMapCenter, this.initialMapZoom);
                });
                
                // Filter button
                document.getElementById('filterBtn').addEventListener('click', () => {
                    document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('filterBtn').classList.add('active');
                    this.toggleSpeciesFilter();
                });
                
                // Refresh button
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('refreshBtn').classList.add('active');
                    this.refreshData();
                });
                
                // Close species filter when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.species-filter') && !e.target.closest('#filterBtn')) {
                        document.getElementById('speciesFilter').classList.remove('active');
                    }
                });
                
                // Handle window resize to switch between modal and popup
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        this.displayWhales(); // Recreate markers with appropriate interaction
                    }, 250);
                });
            }

            closeWhaleModal() {
                document.getElementById('whaleModal').classList.remove('active');
                document.body.style.overflow = 'auto'; // Re-enable scrolling
            }

            async loadWhaleData() {
                try {
                    const whaleSpecies = [
                        'Balaenoptera musculus',
                        'Megaptera novaeangliae',
                        'Balaenoptera physalus',
                        'Balaenoptera acutorostrata',
                        'Eubalaena glacialis',
                        'Physeter macrocephalus',
                        'Orcinus orca',
                        'Globicephala melas',
                        'Delphinus delphis'
                    ];

                    const allData = [];
                    
                    for (const species of whaleSpecies) {
                        try {
                            const response = await fetch(
                                `https://api.gbif.org/v1/occurrence/search?scientificName=${encodeURIComponent(species)}&hasCoordinate=true&hasGeospatialIssue=false&limit=50&year=2025`
                            );
                            
                            if (response.ok) {
                                const data = await response.json();
                                if (data.results) {
                                    allData.push(...data.results);
                                }
                            }
                        } catch (error) {
                            console.warn(`Failed to fetch data for ${species}:`, error);
                        }
                    }

                    this.whaleData = allData.filter(record => 
                        record.decimalLatitude && 
                        record.decimalLongitude &&
                        Math.abs(record.decimalLatitude) <= 90 &&
                        Math.abs(record.decimalLongitude) <= 180
                    );

                    this.updateStats();
                    this.displayWhales();
                    this.createSpeciesFilter();
                    
                } catch (error) {
                    console.error('Error loading whale data:', error);
                    this.showErrorMessage();
                }
            }

            displayWhales() {
                this.markers.forEach(marker => this.map.removeLayer(marker));
                this.markers = [];

                this.whaleData.forEach(whale => {
                    if (this.activeSpecies.size === 0 || this.activeSpecies.has(whale.scientificName)) {
                        const marker = this.createWhaleMarker(whale);
                        marker.addTo(this.map);
                        this.markers.push(marker);
                    }
                });
            }

            createWhaleMarker(whale) {
                const icon = L.divIcon({
                    html: `<div class="whale-marker">${this.getWhaleEmoji(whale.scientificName)}</div>`,
                    className: 'whale-marker-container',
                    iconSize: [50, 50],
                    iconAnchor: [25, 25]
                });

                const marker = L.marker([whale.decimalLatitude, whale.decimalLongitude], { icon });
                
                // On mobile, use modal instead of popup
                if (window.innerWidth <= 768) {
                    marker.on('click', () => this.showWhaleModal(whale));
                } else {
                    // Desktop keeps the popup experience
                    const popupContent = this.createPopupContent(whale);
                    marker.bindPopup(popupContent, {
                        maxWidth: 320,
                        className: 'whale-popup-wrapper',
                        autoPan: true,
                        autoPanPaddingTopLeft: [20, 180],
                        autoPanPaddingBottomRight: [20, 100],
                        keepInView: true
                    });
                }

                return marker;
            }

            showWhaleModal(whale) {
                const modal = document.getElementById('whaleModal');
                const modalImage = document.getElementById('modalImage');
                const modalEmoji = document.getElementById('modalEmoji');
                const modalTitle = document.getElementById('modalTitle');
                const modalLocation = document.getElementById('modalLocation');
                const modalDate = document.getElementById('modalDate');
                const modalCoords = document.getElementById('modalCoords');
                const modalRecorder = document.getElementById('modalRecorder');
                const modalRecorderSection = document.getElementById('modalRecorderSection');
                
                // Get whale data
                const commonName = this.getCommonName(whale.scientificName);
                const imageUrl = this.getWhaleImageUrl(whale.scientificName);
                const emoji = this.getWhaleEmoji(whale.scientificName);
                const date = whale.eventDate ? new Date(whale.eventDate).toLocaleDateString() : 'Unknown date';
                const location = whale.locality || whale.stateProvince || whale.country || 'Open Ocean';
                
                // Set modal content
                modalTitle.textContent = commonName;
                modalLocation.textContent = location;
                modalDate.textContent = date;
                modalCoords.textContent = `${whale.decimalLatitude.toFixed(4)}, ${whale.decimalLongitude.toFixed(4)}`;
                
                // Handle image/emoji
                if (imageUrl) {
                    modalImage.innerHTML = `<img src="${imageUrl}" alt="${commonName}" onerror="this.parentElement.innerHTML='<div class=\\'whale-modal-emoji\\'>${emoji}</div>'">`;
                } else {
                    modalImage.innerHTML = `<div class="whale-modal-emoji">${emoji}</div>`;
                }
                
                // Handle recorder
                if (whale.recordedBy) {
                    modalRecorder.textContent = whale.recordedBy;
                    modalRecorderSection.style.display = 'flex';
                } else {
                    modalRecorderSection.style.display = 'none';
                }
                
                // Show modal
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            getWhaleEmoji(scientificName) {
                const emojiMap = {
                    'Balaenoptera musculus': 'üêã',
                    'Megaptera novaeangliae': 'üêã',
                    'Balaenoptera physalus': 'üêã',
                    'Balaenoptera acutorostrata': 'üêã',
                    'Eubalaena glacialis': 'üêã',
                    'Physeter macrocephalus': 'üêã',
                    'Orcinus orca': 'üêã',
                    'Globicephala melas': 'üêã',
                    'Delphinus delphis': 'üê¨'
                };
                
                // Extract just the genus and species (first two words)
                const binomialName = scientificName.split(' ').slice(0, 2).join(' ');
                return emojiMap[binomialName] || 'üêã';
            }

            getWhaleImageUrl(scientificName) {
                const imageMap = {
                    'Balaenoptera musculus': 'images/blue_whale.jpg',
                    'Megaptera novaeangliae': 'images/humpback_whale.jpg',
                    'Balaenoptera physalus': 'images/fin_whale.jpg',
                    'Balaenoptera acutorostrata': 'images/minke_whale.jpg',
                    'Eubalaena glacialis': 'images/right_whale.jpg',
                    'Physeter macrocephalus': 'images/sperm_whale.jpg',
                    'Orcinus orca': 'images/orca.jpg',
                    'Globicephala melas': 'images/pilot_whale.jpg',
                    'Delphinus delphis': 'images/common_dolphin.jpg'
                };
                
                // Extract just the genus and species (first two words)
                const binomialName = scientificName.split(' ').slice(0, 2).join(' ');
                return imageMap[binomialName] || null;
            }

            getCommonName(scientificName) {
                const nameMap = {
                    'Balaenoptera musculus': 'Blue Whale',
                    'Megaptera novaeangliae': 'Humpback Whale',
                    'Balaenoptera physalus': 'Fin Whale',
                    'Balaenoptera acutorostrata': 'Minke Whale',
                    'Eubalaena glacialis': 'North Atlantic Right Whale',
                    'Physeter macrocephalus': 'Sperm Whale',
                    'Orcinus orca': 'Killer Whale',
                    'Globicephala melas': 'Long-finned Pilot Whale',
                    'Delphinus delphis': 'Common Dolphin'
                };

                const binomialName = scientificName.split(' ').slice(0, 2).join(' ');
                const mappedName = nameMap[binomialName];

                if (mappedName) {
                    return mappedName;
                } else {
                    return scientificName; 
                }
            }

            createPopupContent(whale) {
                const commonName = this.getCommonName(whale.scientificName);
                const date = whale.eventDate ? new Date(whale.eventDate).toLocaleDateString() : 'Unknown date';
                const imageUrl = this.getWhaleImageUrl(whale.scientificName);
                const emoji = this.getWhaleEmoji(whale.scientificName);
                
                const humanReadableLocation = whale.locality || whale.stateProvince || whale.country || 'Open Ocean';

                const popupHTML = `
                    <div class="whale-popup">
                        <div class="whale-popup-header">
                            ${imageUrl ? 
                                `<img src="${imageUrl}" alt="${commonName}">` : 
                                `<div class="whale-popup-emoji">${emoji}</div>`
                            }
                        </div>
                        <div class="whale-popup-content">
                            <div class="whale-popup-badge">Recent Sighting</div>
                            <h3>${commonName}</h3>
                            <p><strong>${humanReadableLocation}</strong></p>
                            <div class="whale-popup-meta">
                                <div class="whale-popup-meta-item">
                                    <span class="meta-icon">üìÖ</span>
                                    <span>${date}</span>
                                </div>
                                <div class="whale-popup-meta-item">
                                    <span class="meta-icon">üìç</span>
                                    <span>Coordinates: <span class="coordinates-display">${whale.decimalLatitude.toFixed(4)}, ${whale.decimalLongitude.toFixed(4)}</span></span>
                                </div>
                                ${whale.recordedBy ? 
                                    `<div class="whale-popup-meta-item">
                                        <span class="meta-icon">üë§</span>
                                        <span>${whale.recordedBy}</span>
                                    </div>` : ''
                                }
                            </div>
                        </div>
                    </div>
                `;

                return popupHTML;
            }

            getCanonicalScientificName(fullScientificName) {
                return fullScientificName.split(' ').slice(0, 2).join(' ');
            }

            createSpeciesFilter() {
                const speciesList = document.getElementById('speciesList');
                speciesList.innerHTML = '';

                const uniqueSpeciesMap = new Map();
                
                this.whaleData.forEach(whale => {
                    const canonicalName = this.getCanonicalScientificName(whale.scientificName);
                    if (!uniqueSpeciesMap.has(canonicalName)) {
                        uniqueSpeciesMap.set(canonicalName, whale.scientificName);
                    }
                });
                
                const sortedCanonicalNames = Array.from(uniqueSpeciesMap.keys()).sort();

                sortedCanonicalNames.forEach(canonicalName => {
                    const originalFullScientificName = uniqueSpeciesMap.get(canonicalName);
                    const commonDisplayName = this.getCommonName(canonicalName);
                    const emoji = this.getWhaleEmoji(canonicalName);

                    const tag = document.createElement('div');
                    tag.className = 'species-tag';
                    tag.innerHTML = `<span><span class="species-emoji">${emoji}</span>${commonDisplayName}</span>`;
                    tag.dataset.scientificName = originalFullScientificName;
                    tag.addEventListener('click', () => this.toggleSpeciesFilter(originalFullScientificName));
                    speciesList.appendChild(tag);
                });
            }

            toggleSpeciesFilter(fullScientificName) {
                if (fullScientificName) {
                    if (this.activeSpecies.has(fullScientificName)) {
                        this.activeSpecies.delete(fullScientificName);
                    } else {
                        this.activeSpecies.add(fullScientificName);
                    }
                    this.displayWhales();
                    this.updateSpeciesFilterUI();
                } else {
                    document.getElementById('speciesFilter').classList.toggle('active');
                }
            }

            updateSpeciesFilterUI() {
                const tags = document.querySelectorAll('.species-tag');
                
                tags.forEach(tag => {
                    const scientificNameFromTag = tag.dataset.scientificName;

                    if (this.activeSpecies.has(scientificNameFromTag)) {
                        tag.classList.add('active');
                    } else {
                        tag.classList.remove('active');
                    }
                });
            }

            async refreshData() {
                const btn = document.getElementById('refreshBtn');
                btn.classList.add('loading');
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<span class="btn-icon">‚è≥</span><span>Loading...</span>';
                
                await this.loadWhaleData();
                
                setTimeout(() => {
                    btn.classList.remove('loading');
                    btn.innerHTML = originalContent;
                }, 500);
            }

            updateStats() {
                document.getElementById('sightingCount').textContent = this.whaleData.length;
                document.getElementById('speciesCount').textContent = new Set(this.whaleData.map(w => w.scientificName)).size;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            hideLoading() {
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 1500);
            }

            showErrorMessage() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.querySelector('.whale-spinner').textContent = 'üåä';
                overlay.querySelector('.loading-text').textContent = 'Unable to connect to whale tracking network';
                overlay.querySelector('.loading-dots').style.display = 'none';
            }
        }

        // Initialize the app
        window.addEventListener('load', () => {
            new WhaleTracker();
        });
    </script>
</body>
</html>