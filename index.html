<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>üêã Whale Tracker - Discover Ocean Giants</title>
<meta name="theme-color" content="#0A1628">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-capable" content="yes">
    <title>üêã Whale Tracker - Discover Ocean Giants</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* --- Base Styles --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Colors */
            --ocean-deep: #0A1628;
            --ocean-dark: #1E3A5F;
            --ocean-primary: #2E5F88;
            --ocean-light: #4A90E2;
            --ocean-accent: #64B5F6;
            --foam-white: #F5F9FF;
            --pure-white: #FFFFFF;
            --coral: #FF6B6B;
            --seafoam: #4ECDC4;
            --sunset: #FFE66D;
            --whale-purple: #7B68EE;

            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(10, 22, 40, 0.08);
            --shadow-md: 0 4px 20px rgba(10, 22, 40, 0.12);
            --shadow-lg: 0 10px 40px rgba(10, 22, 40, 0.15);
            --shadow-xl: 0 20px 60px rgba(10, 22, 40, 0.2);

            /* Standardized Border Radius */
            --border-radius-base: 24px; /* A consistent large radius for main elements */
            --border-radius-pill: 30px; /* For larger pills/buttons */
            --border-radius-sm-pill: 20px; /* For smaller stats pills */


            /* Layout Heights (Desktop Defaults) */
            --controls-height-desktop: 140px; /* Approximate combined height of buttons + stats for desktop */
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal overflow */
            /* Default to hidden for body to prevent scrolling issues with fixed elements */
            overflow-y: hidden; 
            overscroll-behavior-y: contain; /* Prevents rubber-banding/pull-to-refresh */
            /* Apply safe area insets to HTML/body to push content, letting background fill */
            padding-top: env(safe-area-inset-top, 0px);
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--ocean-deep) 0%, var(--ocean-dark) 100%);
            color: var(--pure-white);
            line-height: 1.6;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(78, 205, 196, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 60%, rgba(100, 181, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(123, 104, 238, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        /* Animated Ocean Waves Background */
        .ocean-bg {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background: linear-gradient(180deg, transparent 0%, rgba(46, 95, 136, 0.1) 100%);
            z-index: 0;
            overflow: hidden;
        }

        .wave:nth-child(2) {
            bottom: 10px;
            opacity: 0.5;
            animation-duration: 15s;
            animation-direction: reverse;
        }

        .wave:nth-child(3) {
            bottom: 20px;
            opacity: 0.3;
            animation-duration: 25s;
        }

        @keyframes wave-animation {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* .stats (now moved to bottom) - Hide this if it exists in the header */
        .stats { /* This class should no longer be in the HTML. */
            display: none; 
        }

        /* Map Container */
        .map-container {
            position: relative;
            /* Map height considers the entire viewport minus bottom controls. */
            height: calc(100vh - var(--controls-height-desktop) - 20px); 
            width: 100%;
            margin-top: 0; /* Map goes to the very top */
            z-index: 10;
        }

        #map {
            height: 100%; /* Map takes full height of its container */
            width: 100%;
            position: relative;
            z-index: 10;
        }

        /* Custom Map Styling */
        .leaflet-container {
            background: var(--ocean-deep);
            font-family: 'Inter', sans-serif;
        }

        .leaflet-tile-pane {
            filter: brightness(0.8) contrast(1.2) hue-rotate(180deg) invert(1);
            opacity: 0.7;
        }

        /* --- Controls (Bottom Navigation & Stats) --- */
        .controls {
    position: fixed;
    bottom: calc(20px + env(safe-area-inset-bottom, 0px));
    left: 50%;
    transform: translateX(-50%);
    background: rgba(10, 22, 40, 0.7);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(100, 181, 246, 0.2);
    padding: 0.8rem 1.2rem;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    z-index: 1000;
    border-radius: var(--border-radius-base);
    box-shadow: var(--shadow-xl);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 90%;
    max-width: 550px;
    align-items: center;
    pointer-events: auto; /* NEW - Ensure controls receive touch events */
    touch-action: manipulation; /* NEW - Prevent map panning when touching controls */
}

        .control-app-info { /* Styling for the moved app title and subtitle */
            display: flex;
            align-items: center;
            gap: 0.8rem;
            width: 100%;
            justify-content: center;
            padding-bottom: 0.6rem; /* Space before buttons */
            border-bottom: 1px solid rgba(255, 255, 255, 0.15); /* Separator */
        }

        .giant-whale-small { /* A smaller whale icon for the bottom bar */
            font-size: 2.2rem; /* Adjusted size */
            filter: drop-shadow(0 4px 10px rgba(100, 181, 246, 0.4));
            animation: bob 4s ease-in-out infinite; /* Keep animation */
        }

        .control-text-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .control-app-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.4rem; /* Adjusted title size for bottom */
            font-weight: 700;
            color: var(--pure-white);
            margin: 0;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .control-app-subtitle {
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem; /* Adjusted subtitle size */
            font-weight: 400;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.1rem;
            text-align: center;
        }


        .control-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            width: 100%;
        }

        .control-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius-pill);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            flex-grow: 1; /* Allow buttons to grow evenly */
            text-align: center; /* Center text within buttons */
            justify-content: center; /* Center icon and text within buttons */
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-accent) 100%);
            border-radius: var(--border-radius-pill);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .control-btn:hover {
            color: var(--pure-white);
            transform: translateY(-2px);
        }

        .control-btn:hover::before {
            opacity: 0.2;
        }

        .control-btn.active {
            color: var(--pure-white);
            background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-accent) 100%);
            box-shadow: 0 4px 15px rgba(100, 181, 246, 0.4);
        }

        .control-btn.loading {
            animation: pulse-glow 1.5s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(100, 181, 246, 0.4);
            }
            50% { 
                box-shadow: 0 0 30px rgba(100, 181, 246, 0.6);
            }
        }

        .control-btn .btn-icon {
            font-size: 1.2rem;
        }

        .bottom-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            justify-content: center;
            width: 100%;
            padding-top: 0.6rem;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }

        .stat-pill {
            background: rgba(100, 181, 246, 0.1);
            border: 1px solid rgba(100, 181, 246, 0.25);
            padding: 0.3rem 0.7rem;
            border-radius: var(--border-radius-sm-pill);
            font-size: 0.7rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: default;
            color: var(--pure-white);
        }

        .stat-pill .stat-icon {
            font-size: 0.8rem;
        }

        .stat-pill .stat-value {
            color: var(--ocean-accent);
            font-weight: 600;
            font-size: 0.8rem;
            text-shadow: none;
        }


        /* Species Filter - Modern Card Design */
        .species-filter {
            position: fixed;
            top: calc(20px + env(safe-area-inset-top, 0px)); /* Adjust top for safe area */
            left: 20px;
            right: 20px;
            /* Bottom calculation now needs to factor in the controls height at the bottom */
            bottom: calc(20px + var(--controls-height-desktop) + env(safe-area-inset-bottom, 0px)); 
            max-height: calc(100vh - 40px - var(--controls-height-desktop) - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px)); /* Adjust filter max-height */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 2rem;
            display: none;
            z-index: 999;
            border-radius: var(--border-radius-base);
            box-shadow: var(--shadow-xl);
            overflow-y: auto;
            animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .species-filter.active {
            display: block;
        }

        .filter-header {
            color: var(--ocean-dark);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
            font-family: 'Space Grotesk', sans-serif;
        }

        .species-list {
            display: grid;
            gap: 12px;
        }

        .species-tag {
            background: var(--foam-white);
            border: 2px solid transparent;
            color: var(--ocean-dark);
            padding: 1.2rem;
            border-radius: 16px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .species-tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(100, 181, 246, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .species-tag:hover::before {
            left: 100%;
        }

        .species-tag:hover {
            transform: translateX(5px);
            border-color: var(--ocean-accent);
            box-shadow: var(--shadow-md);
        }

        .species-tag.active {
            background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-accent) 100%);
            color: var(--pure-white);
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(100, 181, 246, 0.3);
        }

        .species-tag .species-emoji {
            font-size: 1.5rem;
            margin-right: 10px;
        }

        /* Whale Markers */
        .whale-marker {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            animation: marker-bounce 2s ease-in-out infinite;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .whale-marker:hover {
            transform: scale(1.2);
        }

        @keyframes marker-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Full Screen Modal for Mobile */
        .whale-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 22, 40, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            overflow-y: auto; /* Allow modal content to scroll if needed */
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .whale-modal.active {
            display: flex;
            flex-direction: column;
            /* Allow modal content to scroll. Body is hidden, so this handles scroll. */
            overflow-y: auto; 
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7); /* Darker background for visibility */
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: all;
            touch-action: manipulation;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .whale-modal-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .whale-modal-image {
            position: relative;
            width: 100%;
            height: 50vh;
            background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .whale-modal-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .whale-modal-emoji {
            font-size: 8rem;
            filter: drop-shadow(0 10px 40px rgba(0, 0, 0, 0.3));
            animation: modalFloat 4s ease-in-out infinite;
        }

        @keyframes modalFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.05); }
        }

        .whale-modal-info {
            flex: 1;
            background: white;
            padding: 2rem;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            margin-top: -30px;
            position: relative;
            color: var(--ocean-dark);
        }

        .whale-modal-badge {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--ocean-accent);
            color: white;
            padding: 0.5rem 2rem;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(100, 181, 246, 0.4);
        }

        .whale-modal-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--ocean-dark);
            margin-bottom: 1rem;
            margin-top: 1.5rem;
            text-align: center;
        }

        .whale-modal-location {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--ocean-dark);
            text-align: center;
            margin-bottom: 2rem;
        }

        .whale-modal-details {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .whale-modal-detail {
            display: flex;
            align-items: flex-start; /* Align icon and text at the top */
            gap: 1rem;
            padding: 1rem;
            background: var(--foam-white);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .whale-modal-detail:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .whale-modal-detail-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            flex-shrink: 0; /* Prevent shrinking */
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
        }

        .whale-modal-detail-content {
            flex: 1;
        }

        .whale-modal-detail-label {
            font-size: 0.85rem;
            color: rgba(10, 22, 40, 0.6);
            font-weight: 500;
            margin-bottom: 0.2rem; /* Spacing between label and value/text */
        }

        .whale-modal-detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--ocean-dark);
        }

        .whale-modal-coordinates {
            font-family: 'Space Grotesk', monospace;
            color: var(--ocean-light);
        }

        .whale-modal-fact-text, .popup-fact-text {
            font-size: 0.85rem; /* xs font size */
            color: var(--ocean-dark);
            line-height: 1.4;
        }

        /* Whale Popups (Desktop Only) */
        .whale-popup {
            color: var(--ocean-dark);
            position: relative;
            overflow: hidden;
        }

        .whale-popup-header {
            position: relative;
            height: 180px;
            background: linear-gradient(135deg, var(--ocean-light) 0%, var(--ocean-accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .whale-popup-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .whale-popup-header img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: relative;
            z-index: 1;
        }

        .whale-popup-emoji {
            font-size: 5rem;
            filter: drop-shadow(0 4px 20px rgba(0, 0, 0, 0.2));
            z-index: 2;
            animation: float 3s ease-in-out infinite;
        }

        .whale-popup-content {
            padding: 1.5rem;
        }

        .whale-popup h3 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--ocean-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .whale-popup-badge {
            display: inline-block;
            background: var(--ocean-accent);
            color: var(--pure-white);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .whale-popup p {
            color: var(--ocean-dark);
            font-size: 0.95rem;
            margin-bottom: 0.8rem;
            line-height: 1.6;
        }

        .whale-popup-meta {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(10, 22, 40, 0.1);
        }

        .whale-popup-meta-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 0.85rem;
            color: rgba(10, 22, 40, 0.6);
        }

        .whale-popup-meta-item .meta-icon {
            font-size: 1rem;
            color: var(--ocean-accent);
            flex-shrink: 0;
        }

        .coordinates-display {
            font-family: 'Space Grotesk', monospace;
            font-size: 0.8rem;
            color: var(--ocean-light);
            background: rgba(10, 22, 40, 0.05);
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            margin-left: 4px;
        }

        /* Loading Screen - Ocean Theme */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--ocean-deep) 0%, var(--ocean-dark) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .whale-spinner {
            font-size: 5rem;
            animation: swim 3s ease-in-out infinite;
            filter: drop-shadow(0 10px 30px rgba(100, 181, 246, 0.3));
            margin-bottom: 2rem;
        }

        @keyframes swim {
            0%, 100% { 
                transform: translateX(0) translateY(0) rotate(0deg);
            }
            25% { 
                transform: translateX(20px) translateY(-10px) rotate(10deg);
            }
            50% { 
                transform: translateX(0) translateY(-20px) rotate(0deg);
            }
            75% { 
                transform: translateX(-20px) translateY(-10px) rotate(-10deg);
            }
        }

        .loading-text {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--ocean-accent);
            letter-spacing: 0.02em;
            animation: fade-pulse 2s ease-in-out infinite;
        }

        @keyframes fade-pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .loading-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 1rem;
        }

        .loading-dot {
            width: 10px;
            height: 10px;
            background: var(--ocean-accent);
            border-radius: 50%;
            animation: dot-wave 1.5s ease-in-out infinite;
        }

        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes dot-wave {
            0%, 100% { 
                transform: translateY(0);
                opacity: 0.3;
            }
            50% { 
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* --- Responsive Design --- */

        /* Desktop adjustments for modal */
        @media (min-width: 769px) {
            .whale-modal-content {
                max-width: 600px;
                margin: 2rem auto;
                border-radius: var(--border-radius-base);
                overflow: hidden;
                min-height: auto;
                box-shadow: var(--shadow-xl);
            }

            .whale-modal-image {
                height: 300px; /* Keep this height for desktop */
                border-radius: var(--border-radius-base) var(--border-radius-base) 0 0;
            }

            .modal-close {
                background: rgba(0, 0, 0, 0.5); /* Semi-transparent black for desktop */
            }

            /* Ensure popups show on desktop */
            .leaflet-popup {
                display: block !important; 
            }
        }

        /* Mobile adjustments (up to 768px) */
        @media (max-width: 768px) {
            :root {
                --controls-height-mobile: 130px; /* Adjusted controls height for mobile */
            }

            .map-container {
                /* Map height now considers safe areas from html/body padding + controls */
                height: calc(100vh - var(--controls-height-mobile) - 10px);
            }

            .controls {
    bottom: calc(10px + env(safe-area-inset-bottom, 0px));
    padding: 0.5rem;
    border-radius: var(--border-radius-base);
    gap: 0.6rem;
    width: 90%;
    max-width: 400px;
    pointer-events: auto; /* NEW - Ensure controls receive touch events */
    touch-action: manipulation; /* NEW - Prevent map panning when touching controls */
}

            .control-app-info {
                padding-bottom: 0.5rem;
                gap: 0.5rem;
            }

            .giant-whale-small {
                font-size: 2rem;
            }

            .control-app-title {
                font-size: 1.2rem;
            }

            .control-app-subtitle {
                font-size: 0.7rem;
            }

            .control-buttons {
                flex-wrap: wrap;
                justify-content: space-around;
                gap: 0.4rem;
            }
            
            .control-btn {
    padding: 0.7rem 1.2rem;
    font-size: 0.85rem;
    flex: 1;
    min-width: 70px;
    border-radius: var(--border-radius-pill);
    pointer-events: auto; /* NEW - Ensure buttons receive touch events */
    touch-action: manipulation; /* NEW - Prevent map panning when touching buttons */
}
            
            /* Hide Leaflet popups on mobile */
            .leaflet-popup {
                display: none !important;
            }

            .whale-popup-content {
                width: 280px !important;
            }

            .whale-popup h3 {
                font-size: 1.2rem;
            }

            .loading-text {
                font-size: 1rem;
            }

            .whale-spinner {
                font-size: 4rem;
            }

            .species-filter {
                top: calc(20px + env(safe-area-inset-top, 0px)); /* Adjust filter top for safe area */
                bottom: calc(10px + var(--controls-height-mobile) + env(safe-area-inset-bottom, 0px)); /* Adjust filter bottom for safe area */
                max-height: calc(100vh - 40px - var(--controls-height-mobile) - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px)); /* Adjust filter max-height */
                padding: 1.5rem;
                left: 10px;
                right: 10px;
                border-radius: var(--border-radius-base);
            }

            .species-tag {
                padding: 1rem;
                font-size: 0.9rem;
                border-radius: 16px;
            }
            /* Modal-specific adjustments for mobile */
            .whale-modal-content {
                min-height: 100vh; /* Ensure it tries to take full height */
            }

            .whale-modal-image {
                height: 30vh; /* Significantly reduce image height on mobile */
                border-radius: 0; /* No top radius for full bleed image */
            }

            .whale-modal-info {
                padding: 1.5rem; /* Slightly reduced padding */
                margin-top: -20px; /* Adjust negative margin */
            }

            .whale-modal-title {
                font-size: 1.8rem; /* Slightly smaller title */
                margin-top: 1rem;
                margin-bottom: 0.8rem;
            }

            .whale-modal-location {
                font-size: 1.1rem; /* Slightly smaller location */
                margin-bottom: 1.5rem;
            }

            .whale-modal-details {
                gap: 1rem; /* Reduced gap between detail items */
                margin-top: 1.5rem; /* Reduced margin */
            }

            .whale-modal-detail {
                padding: 0.8rem; /* Reduced padding for detail rows */
            }

            .whale-modal-detail-label {
                font-size: 0.8rem; /* Smaller label */
            }

            .whale-modal-detail-value {
                font-size: 1rem; /* Smaller value */
            }

            .whale-modal-fact-text {
                font-size: 0.8rem; /* Ensure xs font size on mobile */
            }
        }

        /* Very small mobile adjustments (up to 420px) */
        @media (max-width: 420px) {
            :root {
                --controls-height-mobile: 110px; /* Slightly smaller controls */
            }

            .controls {
    padding: 0.4rem;
    gap: 0.5rem;
    bottom: calc(5px + env(safe-area-inset-bottom, 0px));
    border-radius: var(--border-radius-base);
    width: 95%;
    pointer-events: auto; /* NEW - Ensure controls receive touch events */
    touch-action: manipulation; /* NEW - Prevent map panning when touching controls */
}

            .control-app-info {
                padding-bottom: 0.4rem;
                gap: 0.4rem;
            }
            
            .giant-whale-small {
                font-size: 1.8rem; /* Even smaller whale icon */
            }

            .control-app-title {
                font-size: 1.1rem;
            }

            .control-app-subtitle {
                font-size: 0.65rem;
            }

            .control-buttons {
                gap: 0.3rem;
            }

            .control-btn {
    padding: 0.5rem 0.8rem;
    font-size: 0.75rem;
    gap: 4px;
    min-width: unset;
    border-radius: var(--border-radius-pill);
    pointer-events: auto; /* NEW - Ensure buttons receive touch events */
    touch-action: manipulation; /* NEW - Prevent map panning when touching buttons */
}

            .control-btn .btn-icon {
                display: none;
            }

            .bottom-stats {
                padding-top: 0.3rem;
                gap: 0.3rem;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
            .stat-pill {
                padding: 0.25rem 0.6rem;
                font-size: 0.65rem;
                gap: 3px;
                border-radius: var(--border-radius-sm-pill);
            }
            .stat-pill .stat-icon {
                font-size: 0.75rem;
            }
            .stat-pill .stat-value {
                font-size: 0.75rem;
            }

            .species-filter {
                top: calc(10px + env(safe-area-inset-top, 0px)); /* Adjust for safe area */
                bottom: calc(5px + var(--controls-height-mobile) + env(safe-area-inset-bottom, 0px)); /* Adjust for safe area */
                max-height: calc(100vh - 15px - var(--controls-height-mobile) - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px));
            }
            /* Modal-specific adjustments for very small mobile */
            .whale-modal-image {
                height: 25vh; /* Even smaller image height for very small screens */
            }

            .whale-modal-title {
                font-size: 1.6rem;
            }

            .whale-modal-location {
                font-size: 1rem;
            }

            .whale-modal-fact-text {
                font-size: 0.75rem; /* Potentially even smaller for very small screens */
            }
        }
    </style>
</head>
<body>
    <div class="ocean-bg">
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="wave"></div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="whale-spinner">üêã</div>
            <div class="loading-text">Discovering ocean giants...</div>
            <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        </div>
    </div>

    <div class="whale-modal" id="whaleModal">
        <button class="modal-close" id="modalClose">√ó</button>
        <div class="whale-modal-content">
            <div class="whale-modal-image" id="modalImage">
                <div class="whale-modal-emoji" id="modalEmoji">üêã</div>
            </div>
            <div class="whale-modal-info">
                <div class="whale-modal-badge">Recent Sighting</div>
                <h2 class="whale-modal-title" id="modalTitle">Whale Name</h2>
                <p class="whale-modal-location" id="modalLocation">Location</p>
                
                <div class="whale-modal-details">
                    <div class="whale-modal-detail">
                        <div class="whale-modal-detail-icon">üìÖ</div>
                        <div class="whale-modal-detail-content">
                            <div class="whale-modal-detail-label">Date Spotted</div>
                            <div class="whale-modal-detail-value" id="modalDate">--</div>
                        </div>
                    </div>
                    
                    <div class="whale-modal-detail">
                        <div class="whale-modal-detail-icon">üåç</div>
                        <div class="whale-modal-detail-content">
                            <div class="whale-modal-detail-label">Habitat & Facts</div>
                            <p class="whale-modal-fact-text" id="modalFacts">--</p>
                        </div>
                    </div>
                    </div>
            </div>
        </div>
    </div>

    <div class="species-filter" id="speciesFilter">
        <h2 class="filter-header">Select Species to Track</h2>
        <div class="species-list" id="speciesList"></div>
    </div>

    <div class="map-container">
        <div id="map"></div>
    </div>

    <div class="controls">
        <div class="control-app-info">
            <div class="giant-whale-small">üêã</div>
            <div class="control-text-group">
                <h1 class="control-app-title">Whale Hello</h1>
                <p class="control-app-subtitle">Thanks for all the fish!</p>
            </div>
        </div>
        <div class="control-buttons">
            <button class="control-btn active" id="mapViewBtn">
                <span class="btn-icon">üó∫Ô∏è</span>
                <span>Map</span>
            </button>
            <button class="control-btn" id="filterBtn">
                <span class="btn-icon">üîç</span>
                <span>Filter</span>
            </button>
            <button class="control-btn" id="refreshBtn">
                <span class="btn-icon">üîÑ</span>
                <span>Refresh</span>
            </button>
        </div>
        <div class="bottom-stats">
            <div class="stat-pill">
                <span class="stat-icon">üìç</span>
                <span>Sightings: <span class="stat-value" id="sightingCount">0</span></span>
            </div>
            <div class="stat-pill">
                <span class="stat-icon">üêã</span>
                <span>Species: <span class="stat-value" id="speciesCount">0</span></span>
            </div>
            <div class="stat-pill">
                <span class="stat-icon">üïê</span>
                <span>Updated: <span class="stat-value" id="lastUpdate">--:--</span></span>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        class WhaleTracker {
            constructor() {
                this.map = null;
                this.whaleData = [];
                this.markers = [];
                this.activeSpecies = new Set();
                
                this.initialMapCenter = [20, -140]; // Store initial center
                this.initialMapZoom = 3;             // Store initial zoom
                
                this.init();
            }

            async init() { // Corrected: Added 'async'
                this.initMap();
                this.setupEventListeners();
                await this.loadWhaleData(); // This 'await' is now valid
                this.hideLoading();
                this.updateStats(); 
            }

            initMap() {
                this.map = L.map('map', {
                    zoomControl: false,
                    attributionControl: false,
                    maxBoundsViscosity: 1.0
                }).setView(this.initialMapCenter, this.initialMapZoom);

                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri',
                    maxZoom: 18
                }).addTo(this.map);

                L.control.zoom({
                    position: 'topright'
                }).addTo(this.map);
                
                this.map.on('popupopen', (e) => {
                    const popup = e.popup;
                    const popupHeight = popup._container.offsetHeight;
                    const mapTopBoundary = 20; 
                    
                    const popupTop = this.map.latLngToContainerPoint(popup._latlng).y - popupHeight;
                    
                    if (popupTop < mapTopBoundary) {
                        const targetY = mapTopBoundary + popupHeight / 2 + 20;
                        const targetPoint = L.point(
                            this.map.latLngToContainerPoint(popup._latlng).x,
                            targetY
                        );
                        const targetLatLng = this.map.containerPointToLatLng(targetPoint);
                        
                        this.map.panTo(targetLatLng, {
                            animate: true,
                            duration: 0.5
                        });
                    }
                });
            }

            setupEventListeners() {
                const modalCloseBtn = document.getElementById('modalClose');
                if (modalCloseBtn) {
                    modalCloseBtn.onclick = (e) => {
                        e.stopPropagation();
                        this.closeWhaleModal();
                    };
                }
                
                const whaleModal = document.getElementById('whaleModal');
                if (whaleModal) {
                    whaleModal.onclick = (e) => {
                        if (e.target === whaleModal) {
                            this.closeWhaleModal();
                        }
                    };
                }
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.getElementById('whaleModal').classList.contains('active')) {
                        this.closeWhaleModal();
                    }
                });
                
                document.getElementById('mapViewBtn').addEventListener('click', () => {
                    console.log('Map View Button Clicked!');
                    document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('mapViewBtn').classList.add('active');
                    document.getElementById('speciesFilter').classList.remove('active');
                    
                    this.map.setView(this.initialMapCenter, this.initialMapZoom);
                });
                
                document.getElementById('filterBtn').addEventListener('click', () => {
                    document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('filterBtn').classList.add('active');
                    this.toggleSpeciesFilter();
                });
                
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    document.querySelectorAll('.control-btn').forEach(btn => btn.classList.remove('active'));
                    document.getElementById('refreshBtn').classList.add('active');
                    this.refreshData();
                });
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.species-filter') && !e.target.closest('#filterBtn')) {
                        document.getElementById('speciesFilter').classList.remove('active');
                    }
                });
                
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        this.displayWhales();
                    }, 250);
                });
            }

            closeWhaleModal() {
                // Removed audio stopping logic here
                document.getElementById('whaleModal').classList.remove('active');
                document.body.style.overflow = 'auto'; // Re-enable scrolling
            }

            async loadWhaleData() { 
                try {
                    const whaleSpecies = [
                        'Balaenoptera musculus',
                        'Megaptera novaeangliae',
                        'Balaenoptera physalus',
                        'Balaenoptera acutorostrata',
                        'Eubalaena glacialis',
                        'Physeter macrocephalus',
                        'Orcinus orca',
                        'Globicephala melas',
                        'Delphinus delphis'
                    ];

                    const allData = [];
                    
                    for (const species of whaleSpecies) {
                        try {
                            const response = await fetch(
                                `https://api.gbif.org/v1/occurrence/search?scientificName=${encodeURIComponent(species)}&hasCoordinate=true&hasGeospatialIssue=false&limit=50&year=2025`
                            );
                            
                            if (response.ok) {
                                const data = await response.json();
                                if (data.results) {
                                    allData.push(...data.results);
                                }
                            }
                        } catch (error) {
                            console.warn(`Failed to fetch data for ${species}:`, error);
                        }
                    }

                    this.whaleData = allData.filter(record => 
                        record.decimalLatitude && 
                        record.decimalLongitude &&
                        Math.abs(record.decimalLatitude) <= 90 &&
                        Math.abs(record.decimalLongitude) <= 180
                    );

                    this.updateStats();
                    this.displayWhales();
                    this.createSpeciesFilter();
                    
                } catch (error) {
                    console.error('Error loading whale data:', error);
                    this.showErrorMessage();
                }
            }

            displayWhales() { 
                this.markers.forEach(marker => this.map.removeLayer(marker));
                this.markers = [];

                this.whaleData.forEach(whale => {
                    if (this.activeSpecies.size === 0 || this.activeSpecies.has(whale.scientificName)) {
                        const marker = this.createWhaleMarker(whale);
                        marker.addTo(this.map);
                        this.markers.push(marker);
                    }
                });
            }

            createWhaleMarker(whale) { 
                const icon = L.divIcon({
                    html: `<div class="whale-marker">${this.getWhaleEmoji(whale.scientificName)}</div>`,
                    className: 'whale-marker-container',
                    iconSize: [50, 50],
                    iconAnchor: [25, 25]
                });

                const marker = L.marker([whale.decimalLatitude, whale.decimalLongitude], { icon });
                
                if (window.innerWidth <= 768) {
                    marker.on('click', () => this.showWhaleModal(whale));
                } else {
                    const popupContent = this.createPopupContent(whale);
                    marker.bindPopup(popupContent, {
                        maxWidth: 320,
                        className: 'whale-popup-wrapper',
                        autoPan: true,
                        autoPanPaddingTopLeft: [20, 20], 
                        autoPanPaddingBottomRight: [20, 100],
                        keepInView: true
                    });
                }

                return marker;
            }

            showWhaleModal(whale) {
                const modal = document.getElementById('whaleModal');
                const modalImage = document.getElementById('modalImage');
                const modalEmoji = document.getElementById('modalEmoji');
                const modalTitle = document.getElementById('modalTitle');
                const modalLocation = document.getElementById('modalLocation');
                const modalDate = document.getElementById('modalDate');
                const modalFacts = document.getElementById('modalFacts');
                // REMOVED audio player related variables

                const commonName = this.getCommonName(whale.scientificName);
                const imageUrl = this.getWhaleImageUrl(whale.scientificName);
                const emoji = this.getWhaleEmoji(whale.scientificName);
                const date = whale.eventDate ? new Date(whale.eventDate).toLocaleDateString() : 'Unknown date';
                const location = whale.locality || whale.stateProvince || whale.country || 'Open Ocean';
                const whaleInfo = this.getWhaleInfo(whale.scientificName); // Still call getWhaleInfo for facts

                modalTitle.textContent = commonName;
                modalLocation.textContent = location;
                modalDate.textContent = date;
                modalFacts.textContent = whaleInfo.facts;

                // REMOVED audio handling logic
                
                if (imageUrl) {
                    modalImage.innerHTML = `<img src="${imageUrl}" alt="${commonName}" onerror="this.parentElement.innerHTML='<div class=\\'whale-modal-emoji\\'>${emoji}</div>'">`;
                } else {
                    modalImage.innerHTML = `<div class="whale-modal-emoji">${emoji}</div>`;
                }
                
                modal.classList.add('active');
                document.body.style.overflow = 'hidden'; 
            }

            getWhaleEmoji(scientificName) {
                const emojiMap = {
                    'Balaenoptera musculus': 'üêã',
                    'Megaptera novaeangliae': 'üêã',
                    'Balaenoptera physalus': 'üêã',
                    'Balaenoptera acutorostrata': 'üêã',
                    'Eubalaena glacialis': 'üêã',
                    'Physeter macrocephalus': 'üêã',
                    'Orcinus orca': 'üêã',
                    'Globicephala melas': 'üêã',
                    'Delphinus delphis': 'üê¨'
                };
                
                const binomialName = scientificName.split(' ').slice(0, 2).join(' ');
                return emojiMap[binomialName] || 'üêã';
            }

            getWhaleImageUrl(scientificName) {
                const imageMap = {
                    'Balaenoptera musculus': 'images/blue_whale.jpg',
                    'Megaptera novaeangliae': 'images/humpback_whale.jpg',
                    'Balaenoptera physalus': 'images/fin_whale.jpg',
                    'Balaenoptera acutorostrata': 'images/minke_whale.jpg',
                    'Eubalaena glacialis': 'images/right_whale.jpg',
                    'Physeter macrocephalus': 'images/sperm_whale.jpg',
                    'Orcinus orca': 'images/orca.jpg',
                    'Globicephala melas': 'images/pilot_whale.jpg',
                    'Delphinus delphis': 'images/common_dolphin.jpg'
                };
                
                const binomialName = scientificName.split(' ').slice(0, 2).join(' ');
                return imageMap[binomialName] || null;
            }

            getCommonName(scientificName) {
                const nameMap = {
                    'Balaenoptera musculus': 'Blue Whale',
                    'Megaptera novaeangliae': 'Humpback Whale',
                    'Balaenoptera physalus': 'Fin Whale',
                    'Balaenoptera acutorostrata': 'Minke Whale',
                    'Eubalaena glacialis': 'North Atlantic Right Whale',
                    'Physeter macrocephalus': 'Sperm Whale',
                    'Orcinus orca': 'Killer Whale',
                    'Globicephala melas': 'Long-finned Pilot Whale',
                    'Delphinus delphis': 'Common Dolphin'
                };

                const binomialName = scientificName.split(' ').slice(0, 2).join(' ');
                const mappedName = nameMap[binomialName];

                if (mappedName) {
                    return mappedName;
                } else {
                    return scientificName; 
                }
            }

            getWhaleInfo(scientificName) { 
                const infoMap = {
                    'Balaenoptera musculus': {
                        facts: "Blue whales are found in all oceans, migrating between feeding grounds in polar waters and breeding grounds in warmer, tropical areas. Their vocalizations are among the loudest sounds made by any animal and can travel for hundreds of miles."
                    },
                    'Megaptera novaeangliae': {
                        facts: "Known for their acrobatic breaches and complex songs, humpbacks are found in oceans worldwide and undertake one of the longest migrations of any mammal. They use a unique 'bubble-net feeding' technique to trap fish."
                    },
                    'Balaenoptera physalus': {
                        facts: "The second-largest whale species, fin whales are fast swimmers found in all major oceans, preferring temperate and polar waters. They are often called 'greyhounds of the sea' due to their speed."
                    },
                    'Balaenoptera acutorostrata': {
                        facts: "These smaller baleen whales are widespread in polar, temperate, and tropical waters. They are known for their inquisitive nature and sometimes approach boats."
                    },
                    'Eubalaena glacialis': {
                        facts: "Critically endangered, North Atlantic Right Whales inhabit temperate and subpolar waters of the North Atlantic, typically staying close to the coast. They were named 'right whales' because they were the 'right' ones to hunt."
                    },
                    'Physeter macrocephalus': {
                        facts: "Found in all deep oceans, sperm whales are the largest toothed predators and can dive to extreme depths in search of giant squid. Their enormous, square-shaped heads contain a spermaceti organ."
                    },
                    'Orcinus orca': {
                        facts: "The largest dolphin species, killer whales are highly intelligent and social, found in all oceans from polar to tropical regions. They are apex predators with diverse diets and complex hunting strategies."
                    },
                    'Globicephala melas': {
                        facts: "These highly social dolphins prefer deep, cool temperate waters and are often seen in large, tightly knit pods. They are known for their strong family bonds and can mass strand."
                    },
                    'Delphinus delphis': {
                        facts: "Agile and fast-swimming, common dolphins are found in temperate and tropical oceans worldwide, usually in large groups. They are easily recognizable by their hourglass pattern on their sides."
                    }
                };
                const binomialName = scientificName.split(' ').slice(0, 2).join(' ');
                return infoMap[binomialName] || { facts: "No specific habitat or facts available for this species yet." };
            }


            createPopupContent(whale) {
                const commonName = this.getCommonName(whale.scientificName);
                const date = whale.eventDate ? new Date(whale.eventDate).toLocaleDateString() : 'Unknown date';
                const imageUrl = this.getWhaleImageUrl(whale.scientificName);
                const emoji = this.getWhaleEmoji(whale.scientificName);
                const whaleInfo = this.getWhaleInfo(whale.scientificName);
                
                const humanReadableLocation = whale.locality || whale.stateProvince || whale.country || 'Open Ocean';

                const popupHTML = `
                    <div class="whale-popup">
                        <div class="whale-popup-header">
                            ${imageUrl ? 
                                `<img src="${imageUrl}" alt="${commonName}">` : 
                                `<div class="whale-popup-emoji">${emoji}</div>`
                            }
                        </div>
                        <div class="whale-popup-content">
                            <div class="whale-popup-badge">Recent Sighting</div>
                            <h3>${commonName}</h3>
                            <p><strong>${humanReadableLocation}</strong></p>
                            <div class="whale-popup-meta">
                                <div class="whale-popup-meta-item">
                                    <span class="meta-icon">üìÖ</span>
                                    <span>${date}</span>
                                </div>
                                <div class="whale-popup-meta-item">
                                    <span class="meta-icon">üìç</span>
                                    <span>Coordinates: <span class="coordinates-display">${whale.decimalLatitude.toFixed(4)}, ${whale.decimalLongitude.toFixed(4)}</span></span>
                                </div>
                                ${whale.recordedBy ? 
                                    `<div class="whale-popup-meta-item">
                                        <span class="meta-icon">üë§</span>
                                        <span>${whale.recordedBy}</span>
                                    </div>` : ''
                                }
                                <div class="whale-popup-meta-item">
                                    <span class="meta-icon">üåç</span>
                                    <span class="popup-fact-text">${whaleInfo.facts}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                return popupHTML;
            }

            getCanonicalScientificName(fullScientificName) {
                return fullScientificName.split(' ').slice(0, 2).join(' ');
            }

            createSpeciesFilter() {
                const speciesList = document.getElementById('speciesList');
                speciesList.innerHTML = '';

                const uniqueSpeciesMap = new Map();
                
                this.whaleData.forEach(whale => {
                    const canonicalName = this.getCanonicalScientificName(whale.scientificName);
                    if (!uniqueSpeciesMap.has(canonicalName)) {
                        uniqueSpeciesMap.set(canonicalName, whale.scientificName);
                    }
                });
                
                const sortedCanonicalNames = Array.from(uniqueSpeciesMap.keys()).sort();

                sortedCanonicalNames.forEach(canonicalName => {
                    const originalFullScientificName = uniqueSpeciesMap.get(canonicalName);
                    const commonDisplayName = this.getCommonName(canonicalName);
                    const emoji = this.getWhaleEmoji(canonicalName);

                    const tag = document.createElement('div');
                    tag.className = 'species-tag';
                    tag.innerHTML = `<span><span class="species-emoji">${emoji}</span>${commonDisplayName}</span>`;
                    tag.dataset.scientificName = originalFullScientificName;
                    tag.addEventListener('click', () => this.toggleSpeciesFilter(originalFullScientificName));
                    speciesList.appendChild(tag);
                });
            }

            toggleSpeciesFilter(fullScientificName) {
                if (fullScientificName) {
                    if (this.activeSpecies.has(fullScientificName)) {
                        this.activeSpecies.delete(fullScientificName);
                    } else {
                        this.activeSpecies.add(fullScientificName);
                    }
                    this.displayWhales();
                    this.updateSpeciesFilterUI();
                } else {
                    document.getElementById('speciesFilter').classList.toggle('active');
                }
            }

            updateSpeciesFilterUI() {
                const tags = document.querySelectorAll('.species-tag');
                
                tags.forEach(tag => {
                    const scientificNameFromTag = tag.dataset.scientificName;

                    if (this.activeSpecies.has(scientificNameFromTag)) {
                        tag.classList.add('active');
                    } else {
                        tag.classList.remove('active');
                    }
                });
            }

            async refreshData() {
                const btn = document.getElementById('refreshBtn');
                btn.classList.add('loading');
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<span class="btn-icon">‚è≥</span><span>Loading...</span>';
                
                await this.loadWhaleData();
                
                setTimeout(() => {
                    btn.classList.remove('loading');
                    btn.innerHTML = originalContent;
                }, 500);
            }

            updateStats() {
                document.getElementById('sightingCount').textContent = this.whaleData.length;
                document.getElementById('speciesCount').textContent = new Set(this.whaleData.map(w => w.scientificName)).size;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            hideLoading() {
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 1500);
            }

            showErrorMessage() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.querySelector('.whale-spinner').textContent = 'üåä';
                overlay.querySelector('.loading-text').textContent = 'Unable to connect to whale tracking network';
                overlay.querySelector('.loading-dots').style.display = 'none';
            }
        }

        // Initialize the app
        window.addEventListener('load', () => {
            new WhaleTracker();
        });
    </script>
</body>
</html>